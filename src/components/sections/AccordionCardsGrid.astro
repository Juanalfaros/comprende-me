---
import { Image } from 'astro:assets';
// 1. Importamos el TIPO de post correcto desde contentful-utils
import type { CleanPost } from '../../lib/contentful-utils.ts';

// 2. Definimos TODAS las props que le pasamos desde index.astro
interface Props {
  id?: string;
  title: string;
  subtitle: string;
  posts: CleanPost[]; // Usamos el tipo CleanPost, no el genérico
  moreLinkHref: string;
  moreLinkText: string;
}

// 3. Destructuramos TODAS las props
const { id, title, subtitle, posts, moreLinkHref, moreLinkText } = Astro.props;

// Función de formateo de fecha
const formatDate = (dateString: string) => {
  return new Date(dateString).toLocaleDateString('es-CL', {
    day: '2-digit',
    month: '2-digit',
    year: 'numeric',
    timeZone: 'UTC',
  });
};
---

<section {id} class="section">
    <div class="container text-center">
        <h2 class="section-title">{title}</h2>
        <h3>{subtitle}</h3>
    </div>

    <div class="accordion-grid container">
    {posts.map((post, index) => {
        // Formateamos la fecha para este post
        const formattedDate = formatDate(post.publishedDate);

        return (
            <div class:list={[
                "accordion-grid__card",
                { "accordion-grid__card--is-open": index === 0 } 
            ]}>
                <div class="accordion-grid__content">
                    
                    <div class="accordion-grid__panel accordion-grid__panel--text">
                        <h2 class="accordion-grid__title">
                            <a href={`/blog/${post.slug}`}>{post.title}</a>
                        </h2>
                        <div class="accordion-grid__meta">
                            <time datetime={post.publishedDate}>{formattedDate}</time>
                            <span>•</span>
                            <span>{post.duration}</span>
                        </div>
                        
                        <p class="accordion-grid__excerpt">{post.excerpt}</p>
                        
                        <a href={`/blog/${post.slug}`} class:list={["accordion-grid__button", "btn", "btn-primary"]}>
                            <span>Leer Más</span> <i class="ph ph-arrow-right"></i>
                        </a>
                    </div>
                    
                    <div class="accordion-grid__panel accordion-grid__panel--image">
                        <Image 
                          src={post.image} 
                          alt={post.alt} 
                          width={post.imageWidth || 400} 
                          height={post.imageHeight || 280}
                          format="webp"
                          quality={80}
                        />
                        
                        <div class="accordion-grid__tags">
                            {post.tags.slice(0, 2).map(tag => (
                                <span class="accordion-grid__tag">{tag}</span>
                            ))}
                        </div>
                    </div>

                </div>
            </div>
        )
    })}
    </div>

    <div class="container text-center" style="margin-top: 2.5rem;">
        <a href={moreLinkHref} class="btn btn-primary">
            {moreLinkText}
        </a>
    </div>
</section>


<style>
    /* * {border: 1px dotted blue;} */
    
    /* Hice un pequeño ajuste aquí para que el .accordion-grid 
       no sea un container, sino que esté DENTRO de uno. */
    .accordion-grid {
        display: flex;
        gap: 20px; 
        width: 100%; /* Ocupa el 100% del container padre */
    }

    /* --- La Máscara (Tarjeta) --- */
    .accordion-grid__card {
        height: 320px;
        border-radius: 48px; 
        border: 1px solid var(--color-border);
        display: flex;
        align-items: center;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        overflow: hidden; 
        transition: flex 0.5s cubic-bezier(0.77, 0, 0.175, 1);
        flex: 1; /* CERRADO */
        
    }

    .accordion-grid__card--is-open {
        flex: 2; /* ABIERTO */
    }

    /* --- El Contenido --- */
    .accordion-grid__content {
        width: var(--content-width-px); 
        height: 100%;
        display: flex; 
        transform: translateZ(0); 
        flex-direction: row;
        flex-shrink: 0;
        
    }

    /* --- Los Paneles --- */
    .accordion-grid__panel {
        width: var(--panel-width-px); 
        height: 100%;
        box-sizing: border-box;
        flex-shrink: 0;
    }

    .accordion-grid__panel--text {
      position: relative;
      background: var(--color-primary);
      display: flex;
      flex-direction: column;
      padding: 1.7rem;
      transition: background 0.3s ease-in-out;
      overflow: hidden; 
    }

    .accordion-grid__card--is-open .accordion-grid__panel--text {
        background: var(--color-white);
    }

    /* --- Meta (fecha, duración) --- */
    .accordion-grid__meta {
        font-size: 0.8rem;
        color: var(--color-white);
        margin-bottom: 0.5rem;
        font-weight: 500;
    }

    .accordion-grid__card--is-open .accordion-grid__meta {
        color: var(--color-primary-dark);
    }

    /* --- Título --- */
    .accordion-grid__title {
        font-family: var(--font-heading);
        color: var(--color-dark);
        font-size: 1.25rem; 
        font-weight: 600; 
        line-height: 1.2; 
        margin: 0 0 0.5rem 0; 
    }

    .accordion-grid__card--is-open .accordion-grid__title {
        color: var(--color-dark);
    }

    .accordion-grid__title a {
        color: inherit;
        text-decoration: none;
    }
    .accordion-grid__title a:hover {
        color: var(--color-primary-dark);
    }

    /* --- Extracto --- */
    .accordion-grid__panel--text p {
        font-family: var(--font-sans);
        color: var(--color-dark);
        line-height: 1.6;
        font-size: 0.9rem; 
        margin-bottom: 1rem; 
        
        /* Truncado */
        display: -webkit-box;
        -webkit-line-clamp: 3;
        line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .accordion-grid__card--is-open .accordion-grid__panel--text p {
        color: var(--color-muted);
    }

    /* --- Botón --- */
    .accordion-grid__button {
        margin-top: auto;
        text-align: center;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        width: fit-content;
        padding-right: 1.1rem;
        padding-left: 1.1rem;
    }

    .accordion-grid__button {
        background-color: var(--color-white);
    }

    /* Animación del span del botón */
    .accordion-grid__button span {
        display: inline-block;
        overflow: hidden;
        white-space: nowrap;
        max-width: 0;
        opacity: 0;
        margin-left: -0.5rem;
        vertical-align: middle;
        transition: max-width 0.5s ease-in-out, 
                    opacity 0.5s ease-in-out, 
                    margin-left 0.3s ease-in-out;
    }

    .accordion-grid__card--is-open .accordion-grid__button span {
        opacity: 1;
        max-width: 200px; 
        margin-left: 0; 
    }

    .accordion-grid__card--is-open .accordion-grid__button {
        background-color: var(--color-primary);
        padding-left: 1.5rem;
    }

    /* Animación del ícono del botón */
    .accordion-grid__button i {
        font-size: 1.3rem;
        transition: transform 0.3s ease-in-out;
    }

    .accordion-grid__card--is-open .accordion-grid__button i {
        transform: rotate(-30deg);
    }

    /* --- Panel Derecho (Imagen) --- */
    .accordion-grid__panel--image {
        display: flex;
        justify-content: center; 
        align-items: center;     
        position: relative;
        overflow: hidden;
        background-color: var(--color-white);
        padding: 1.7rem 1.7rem 1.7rem 0;
    }

    .accordion-grid__panel--image img,
    .accordion-grid__panel--image ::slotted(img) {
        width: 100%;
        height: 100%;
        object-fit: cover;
        object-position: center;
        display: block;
        border-radius: 30px;
        transition: transform 0.3s ease;
        margin-right: 10px; /* Este margen parece estar de más, lo saqué */
        margin: 0; /* Aseguramos que no haya márgenes */
    }
    
    /* --- Tags --- */
    .accordion-grid__tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        position: absolute;
        bottom: 1.7rem;
       
        z-index: 1;
        padding: 15px;
        padding-bottom: 20px;
        align-items: start;
        justify-content: start;
    }

    .accordion-grid__tag {
        font-size: 0.65rem;
        background-color: rgba(255, 255, 255, 0.15);
        color: #fff;
        padding: 0.35rem 0.85rem;
        border-radius: 9999px;
        border: 1px solid rgba(255, 255, 255, 0.4);
        backdrop-filter: blur(4px);
    }

    /* --- Media Query para Mobile --- */
    @media (max-width: 768px) {
        .accordion-grid {
            flex-direction: column;
            width: 90vw;
            max-width: 500px;
            margin: 0 auto;
            gap: 1.5rem;
        }

        .accordion-grid__card,
        .accordion-grid__card--is-open {
            flex: 1 1 auto;
            width: 100%;
            height: auto;
        }

        .accordion-grid__content {
            width: 100% !important;
            flex-direction: column;
        }

        .accordion-grid__panel {
            width: 100% !important;
        }

        .accordion-grid__panel--image {
            order: -1; 
            width: 100%;
            aspect-ratio: 16 / 10;
            background-color: transparent; /* Era 'none', mejor 'transparent' */
            justify-content: center;
            align-items: center;
            padding-bottom: 0;
            padding: 0; /* Reseteamos padding para mobile */
        }

        .accordion-grid__panel--image img,
        .accordion-grid__panel--image ::slotted(img) {
            width: 100%;
            height: 100%;
            object-fit: cover;
            margin: 0;
            transform: none;
            border-radius: 30px; /* Mantenemos el borde redondeado */
        }

        .accordion-grid__tags {
            bottom: 1rem;
            left: 1rem; /* Queda mejor que '2rem' */
            padding: 10px; /* Un poco menos de padding */
            align-items: start;
            justify-content: start;
        }

        .accordion-grid__card--is-open .accordion-grid__panel--image img {
            transform: none;
        }
    }

    h3 {
        margin: auto;
        margin-bottom: 2rem;
    }
</style>

<script>
  // Importamos el script aquí, en el lado del cliente.
  // Astro lo procesará y lo enviará al navegador.
  import '../../lib/accordion-grid.ts';
</script>