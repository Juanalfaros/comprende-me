---
// src/pages/blog/[slug].astro
import { Image } from "astro:assets";
import Layout from "../../layouts/Layout.astro";
import { createClient } from "../../lib/contentful.js"; 
import ArticleCard from "../../components/ArticleCard.astro";
import AuthorBio from "../../components/AuthorBio.astro";
import SocialShare from "../../components/SocialShare.astro";

import {
  transformPost,
  type CleanPost,
  type ContentfulPostFields,
} from "../../lib/contentful-utils";

import { authorData } from "../../data/authorData.js";
import "../../styles/article.css";

const { slug } = Astro.params;
const isPreview = Astro.url.searchParams.get('preview') === 'true';

let post: CleanPost | null = null;
let relatedPosts: CleanPost[] = [];

try {
  const client = createClient(isPreview);

  const response = await client.getEntries({
    content_type: "blogPost",
    "fields.slug": slug,
    limit: 1,
    include: 2,
  });

  const postFields = response.items[0]?.fields as unknown as ContentfulPostFields;

  if (!postFields) {
    return Astro.redirect('/404');
  }

  post = transformPost(postFields);

  // --- LOGICA DE RELACIONADOS CORREGIDA ---
  
  const relatedResponse = await createClient(false).getEntries({
      content_type: "blogPost",
      limit: 10 
  });

  // CORRECCI√ìN 1: Tipado expl√≠cito de 'item' como 'any' para evitar error 7006
  const allRelatedFields = relatedResponse.items.map(
    (item: any) => item.fields as unknown as ContentfulPostFields,
  );

  const allCleanRelated = allRelatedFields.map(transformPost);

  // CORRECCI√ìN 2: Aseguramos que 'post' existe dentro del filtro
  relatedPosts = allCleanRelated
      .filter(
        (related: CleanPost) => // Tipamos 'related'
          post && // Verificamos que 'post' no es null
          related.slug !== post.slug &&
          related.tags.some((tag: string) => post!.tags.includes(tag)) // Usamos 'post!' o verificamos arriba
      )
      .slice(0, 3);

} catch (error) {
  console.error("Error fetching data from Contentful:", error);
  return Astro.redirect('/404');
}

// Si llegamos aqu√≠ y post sigue siendo null (caso raro de error no capturado), redirigimos
if (!post) return Astro.redirect('/404');

const formattedDate = new Date(post.publishedDate).toLocaleDateString("es-CL", {
  year: "numeric",
  month: "long",
  day: "numeric",
  timeZone: "UTC",
});

const articleSchema = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  headline: post.title,
  description: post.excerpt,
  image: post.image,
  datePublished: post.publishedDate,
  author: {
    "@type": "Person",
    name: authorData.name,
  },
  publisher: {
    "@type": "Organization",
    name: "Comprende.me",
    logo: {
      "@type": "ImageObject",
      url: new URL("/favicon.svg", Astro.site).href,
    },
  },
  mainEntityOfPage: {
    "@type": "WebPage",
    "@id": Astro.url.href,
  },
};
---

<Layout
  title={`${post.title} | Comprende.me`}
  description={post.excerpt}
  image={post.image}
>
  <Fragment slot="head-extra">
    <script
      type="application/ld+json"
      set:html={JSON.stringify(articleSchema)}
    />
  </Fragment>

  {/* AVISO VISUAL: Solo aparece si est√°s viendo el borrador */}
  {isPreview && (
    <div style="background-color: #fef08a; color: #854d0e; text-align: center; padding: 0.5rem; font-weight: bold; border-bottom: 1px solid #eab308;">
      üëÅÔ∏è MODO PREVISUALIZACI√ìN (BORRADOR)
    </div>
  )}

  <main>
    <section class="section article-main-section">
      <div class="container">
        <article>

          <div class="article-header">
          <h1>{post.title}</h1>
          <div class="article-meta-info">
            <div>
              <time datetime={post.publishedDate}
                ><i class="ph ph-calendar-heart"></i>{formattedDate}</time
              >
              <span aria-hidden="true">‚Ä¢</span>
              <span><i class="ph ph-clock"></i> {post.duration}</span>
            </div>
            <div class="tags-meta">
              {post.tags.map((tag) => <span class="tag">{tag}</span>)}
            </div>
          </div>
          
          <Image
            src={post.image}
            alt={post.alt}
            class="article-main-image"
            loading="eager"
            fetchpriority="high"
            width={post.imageWidth}
            height={post.imageHeight}
            transition:name={`blog-image-${post.slug}`}
          />
          </div>

          <div class="article-body" set:html={post.fullContentHTML} />

          {
            post.fuentesHTML && (
              <div class="article-sources" set:html={post.fuentesHTML} />
            )
          }

          <div class="article-body-width">
            <SocialShare url={Astro.url} title={post.title} />
          
          <AuthorBio />
          
            <a href="/blog" class="back-to-blog-link">
              <i class="ph ph-arrow-arc-left"></i> Volver a todos los art√≠culos
            </a>
          </div>
        </article>

        {
          relatedPosts.length > 0 && (
            <section class="related-articles">
              <h2>Art√≠culos Relacionados</h2>
              <div class="grid grid-3-cols">
                {relatedPosts.map((relatedPost) => (
                  <ArticleCard post={relatedPost} />
                ))}
              </div>
            </section>
          )
        }
      </div>
    </section>
  </main>
</Layout>
