---
// src/pages/blog/[slug].astro
export const prerender = true;

// --- 1. IMPORTACIONES ---
import { Image } from 'astro:assets';
import Layout from '../../layouts/Layout.astro';
import { client } from '../../lib/contentful.js';
import ArticleCard from '../../components/ArticleCard.astro';
import AuthorBio from '../../components/AuthorBio.astro';
import SocialShare from '../../components/SocialShare.astro';

import { transformPost, type CleanPost, type ContentfulPostFields } from '../../lib/contentful-utils';

import { authorData } from '../../data/authorData.js';

export async function getStaticPaths() {
  
const response = await client.getEntries({ content_type: 'blogPost' });
const allFields = response.items.map(item => item.fields as unknown as ContentfulPostFields);

const allCleanPosts: CleanPost[] = allFields.map(transformPost); 

  return allCleanPosts.map(post => {
    const relatedPosts = allCleanPosts.filter(related => 
        related.slug !== post.slug &&
        related.tags.some(tag => post.tags.includes(tag))
    ).slice(0, 3);
    
    return {
      params: { slug: post.slug },
      props: { post, relatedPosts },
    };
  });
}


const { post, relatedPosts } = Astro.props as { post: CleanPost, relatedPosts: CleanPost[] };

const formattedDate = new Date(post.publishedDate).toLocaleDateString('es-CL', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
    timeZone: 'UTC',
});

const articleSchema = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": post.title,
  "description": post.excerpt,
  "image": post.image,
  "datePublished": post.publishedDate,
  "author": {
    "@type": "Person",
    "name": authorData.name,
  },
  "publisher": {
    "@type": "Organization",
    "name": "Comprende.me",
    "logo": {
      "@type": "ImageObject",
      "url": new URL('/favicon.svg', Astro.site).href
    }
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": Astro.url.href
  }
};
---

<Layout 
    title={`${post.title} | Comprende.me`}  
    description={post.excerpt}
    image={post.image}
>
    
    <Fragment slot="head-extra">
        <link rel="stylesheet" href="/styles/article.css" />
        <script type="application/ld+json" set:html={JSON.stringify(articleSchema)} />
    </Fragment>

    <main>
    <section class="section article-main-section">
        <div class="container">
            <article>
              
              <h1>{post.title}</h1>
              <div class="article-meta-info">
                    <time datetime={post.publishedDate}><i class="ph ph-calendar-heart"></i>{formattedDate}</time>
                    <span aria-hidden="true">•</span>
                    <span><i class="ph ph-clock"></i> {post.duration}</span>
                    {post.tags.map(tag => (
                        <span class="tag">{tag}</span>
                    ))}
              </div>
              <Image 
                    src={post.image}
                    alt={post.alt} 
                    class="article-main-image"
                    loading="eager"
                    fetchpriority="high"
                    width={post.imageWidth}
                    height={post.imageHeight}
                />
                    
                    <div class="article-body" set:html={post.fullContentHTML} />

                    {post.fuentesHTML && (
                      <div class="article-sources" set:html={post.fuentesHTML} />
                    )}

                    <SocialShare url={Astro.url} title={post.title} />
                    <AuthorBio />
                    
                    <a href="/blog" class="back-to-blog-link">
                        <i class="ph ph-arrow-arc-left"></i> Volver a todos los artículos
                    </a>
                </article>

                {relatedPosts.length > 0 && (
                    <section class="related-articles">
                        <h2>Artículos Relacionados</h2>
                        <div class="grid grid-3-cols">
                            {relatedPosts.map(relatedPost => (
                                <ArticleCard post={relatedPost} />
                            ))}
                        </div>
                    </section>
                )}
            </div>
        </section>
    </main>
</Layout>